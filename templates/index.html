<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Assistance Locator</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f7 100%);
      color: #0C4058;
    }

    header {
      background: linear-gradient(135deg, #ffffff 0%, #f8fffe 100%);
      border-bottom: 2px solid #5DBA68;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(12, 64, 88, 0.1);
      position: relative;
    }

    .back-button {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: #5DBA68;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      transition: color 0.3s ease;
    }

    .back-button:hover {
      color: #29A296;
    }

    .language-selector {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    .language-selector label {
      font-size: 12px;
      color: #0C4058;
      font-weight: 500;
      margin-right: 8px;
    }

    .language-selector select {
      padding: 6px 10px;
      border: 1px solid rgba(93, 186, 104, 0.3);
      border-radius: 6px;
      background: white;
      color: #0C4058;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .language-selector select:focus {
      outline: none;
      border-color: #5DBA68;
      box-shadow: 0 0 0 2px rgba(93, 186, 104, 0.1);
    }
    

    .content {
      display: flex;
      padding: 40px;
      gap: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .controls {
      width: 30%;
      background: linear-gradient(135deg, #ffffff 0%, #f8fffe 100%);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(12, 64, 88, 0.1);
      border: 1px solid rgba(93, 186, 104, 0.2);
    }

    .controls label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
      color: #0C4058;
    }

    .controls input, .controls button {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid rgba(93, 186, 104, 0.3);
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .controls input:focus {
      outline: none;
      border-color: #5DBA68;
      box-shadow: 0 0 0 3px rgba(93, 186, 104, 0.1);
    }

    input:invalid {
      border: 1px solid red;
    }
    

    .controls button {
      background: linear-gradient(135deg, #5DBA68 0%, #66B65D 100%);
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 16px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(93, 186, 104, 0.3);
    }

    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(93, 186, 104, 0.4);
    }

    .map-container {
      width: 70%;
      height: 500px;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(12, 64, 88, 0.1);
    }

    .agent-info {
      margin-top: 30px;
      font-size: 14px;
      background: linear-gradient(135deg, #f0f9f7 0%, #e8f5f3 100%);
      padding: 15px;
      border-left: 4px solid #5DBA68;
      border-radius: 8px;
      color: #0C4058;
    }

    .vapi-buttons {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .vapi-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .vapi-buttons button#call-btn {
      background-color: #28a745;
      color: white;
    }

    .vapi-buttons button#hangup-btn {
      background-color: #dc3545;
      color: white;
    }

    .toggle-container {
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .toggle-label {
      font-size: 16px;
      font-weight: 500;
      color: #0C4058;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #5DBA68;
    }
    
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    

    .fancy-dropdown {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 10px 12px;
      border-radius: 5px;
      font-size: 14px;
      width: 100%;
      font-family: 'Inter', sans-serif;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1.41.59L6 5.17l4.59-4.58L12 2l-6 6-6-6z' fill='%23666'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
      transition: border 0.3s;
    }
    
    .fancy-dropdown:focus {
      border-color: #5DBA68;
      outline: none;
      box-shadow: 0 0 0 3px rgba(93, 186, 104, 0.1);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .content {
        flex-direction: column;
        padding: 20px;
        gap: 20px;
      }

      .map-container {
        width: 100%;
        height: 50vh;
        order: 1;
      }

      .controls {
        width: 100%;
        order: 2;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(12, 64, 88, 0.1);
        border: 1px solid rgba(93, 186, 104, 0.2);
      }

      .back-button {
        font-size: 14px;
        left: 15px;
      }

      .language-selector {
        right: 15px;
      }

      .language-selector label {
        font-size: 11px;
      }

      .language-selector select {
        font-size: 11px;
        padding: 4px 8px;
      }

      .controls input, .controls button {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px;
      }

      .controls label {
        font-size: 14px;
        margin-top: 15px;
      }

      .controls button {
        margin-top: 20px;
        padding: 15px;
        font-size: 16px;
      }

      .toggle-container {
        margin-top: 15px;
      }

      .toggle-label {
        font-size: 14px;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .content {
        padding: 15px;
      }

      .back-button {
        font-size: 12px;
        left: 10px;
      }

      .language-selector {
        right: 10px;
      }

      .language-selector label {
        font-size: 10px;
      }

      .language-selector select {
        font-size: 10px;
        padding: 3px 6px;
      }

      .controls {
        padding: 15px;
      }

      .map-container {
        height: 45vh;
      }
    }

  </style>
</head>

<body>

  <header>
    <a href="/" class="back-button">
      ‚Üê Back to Home
    </a>
    
    <div class="language-selector">
      <label for="languageSelector">Language:</label>
      <select id="languageSelector" onchange="setLanguage(this.value)">
        <option value="en">English</option>
        <option value="es">Espa√±ol</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      </select>
    </div>
  </header>

  <div class="content">
    <!-- Left Panel -->
    <div class="controls">
      <label for="zip">ZIP Code</label>
      <input type="text" id="zip" placeholder="e.g. 20740" maxlength="5" pattern="\d{5}" inputmode="numeric" oninput="validateZipInput(this)" />
      
      <!-- START OF ZIP INPUT VALIDATION STUFF -->
      <script>
        function validateZipInput(input) {
          // Remove non-numeric characters
          input.value = input.value.replace(/\D/g, '');
        }
      </script>
      <!-- END OF ZIP INPUT VALIDATION STUFF -->



      <label for="radius">Search Radius (miles)</label>
      <input type="number" id="radius" placeholder="1 to 100 miles" value="5" min="1" max="100" step="1" oninput="validateRadiusInput(this)" />

      <!-- START OF RADIUS INPUT VALIDATION STUFF -->
      <script>
        function validateRadiusInput(input) {
          // Remove symbols, negative signs, decimals, and non-digits
          input.value = input.value.replace(/[^\d]/g, '');
        
          // Convert to number and clamp the range to 1‚Äì100
          let value = parseInt(input.value);
          if (value > 100) input.value = 100;
          else if (value < 1 && input.value !== '') input.value = 1;
        }
        
      </script>
      <!-- END OF RADIUS INPUT VALIDATION STUFF -->



      <button onclick="search()">Search by ZIP </button>
      <button onclick="searchFromCurrentLocation()">Search From My Location üìå</button>

      
      <label for="day">Day of the Week</label>
      <select id="day" class="fancy-dropdown">
        <option value="monday">Monday</option>
        <option value="tuesday">Tuesday</option>
        <option value="wednesday">Wednesday</option>
        <option value="thursday">Thursday</option>
        <option value="friday">Friday</option>
        <option value="saturday">Saturday</option>
        <option value="sunday">Sunday</option>
      </select>


      <div class="toggle-container">
        <label class="switch">
          <input type="checkbox" id="homeDelivery">
          <span class="slider round"></span>
        </label>
        <span class="toggle-label"><strong>I prefer home delivery (if available)</strong></span>
      </div>
      
      <!--
      <div class="agent-info">
        <p><strong>Want to talk to somebody?</strong></p>
        <p>Try our AI voice assistant:</p>
        <p><strong>üìû +1 240-782-8375</strong></p>
        <p style="color: gray; font-style: italic;">Web call feature coming soon</p>
      </div>

      -->
      <!-- VAPI Buttons (Disabled) -->

      <!--
      <div class="vapi-buttons">
        <button id="call-btn" disabled>üìû Call Agent</button>
        <button id="hangup-btn" disabled>‚ùå Hang Up</button>
      </div>
    </div>
    -->




    
    </div>  
    <!-- Right Panel (Map) -->
  <div class="map-container">
    <div id="map"></div>
  </div>
  

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap" async defer></script>

  <script>
    let map, originCoords, markers = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 38.9072, lng: -77.0369 },
        zoom: 10,
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            originCoords = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            new google.maps.Marker({
              position: originCoords,
              map: map,
              title: "Your Location",
              icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });
            map.setCenter(originCoords);
          },
          () => alert("Geolocation failed.")
        );
      }
    }

    async function search() {
      const zip = document.getElementById("zip").value;
      const radius = document.getElementById("radius").value;
      const day = document.getElementById("day").value;
      const homeDelivery = document.getElementById("homeDelivery").checked;
      //if (!zip) return alert("Enter a ZIP code.");
      if (!zip) return alert(translations[currentLang].zipError);  // For Multilingual Support
      
     // Checking if ZIP exists using Zippopotam.us API
     const zipValid = await fetch(`https://api.zippopotam.us/us/${zip}`).then(res => res.ok);
     //if (!zipValid) return alert("Invalid ZIP code.");
     if (!zipValid) return alert(translations[currentLang].zipInvalid); // For Multilingual Support
        

      fetch(`/search?address=${zip}&radius=${radius}&day=${day}&homeDelivery=${homeDelivery}`)
        .then(async res => {
          if (!res.ok) {
            const errorData = await res.json();
            return alert(errorData.error || "An unexpected error occurred.");
            //return [];
          }
          return res.json();
        })
        .then(data => {
          markers.forEach(marker => marker.setMap(null));
          markers = [];

          //if (data.length === 0) return alert("No centers found.");
          if (data.length === 0) return alert(translations[currentLang].noCenters); // For Multilingual Support

        
          map.setCenter({ lat: data[0].latitude, lng: data[0].longitude });

          data.forEach(site => {
            // Use bright orange marker for agencies with updates
            const markerColor = site.has_updates ? '#FF4500' : '#5DBA68';
            const markerIcon = site.has_updates ? 
              'http://maps.google.com/mapfiles/ms/icons/orange-dot.png' : 
              'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            
            const marker = new google.maps.Marker({
              position: { lat: site.latitude, lng: site.longitude },
              map: map,
              title: site.name,
              phone: site.phone,
              icon: markerIcon
            });

            const updatesInfo = site.has_updates ? 
              `<br><strong style="color: #FF4500; font-size: 14px; background: #FFF3E0; padding: 5px; border-radius: 5px; display: inline-block;">üì¢ ${site.updates}</strong><br>` : '';
            
            const info = new google.maps.InfoWindow({
              content: `<strong>${site.name}</strong><br><br>
              <strong>Address:</strong> ${site.address}<br>
              <strong>Distance:</strong> ${site.distance} mi away <br>
              <strong>Phone:</strong> ${site.phone}<br>
              <strong>Hours of Operation:</strong> ${site.hours}<br>  
              <strong>Appointment:</strong> ${site.appointment}<br>
              <strong>Prepared Meals:</strong> ${site.Prepared_meals}<br>
              <strong>Home Delivery:</strong> ${site.home_delivery}<br>
              ${updatesInfo}
              <button onclick="navigateTo(${site.latitude}, ${site.longitude})">Get Directions</button>`
            });

            marker.addListener("click", () => info.open(map, marker));
            markers.push(marker);
          });
        });
    }

    function searchFromCurrentLocation() {
      //if (!originCoords) return alert("Unable to get your location.");
      if (!originCoords) return alert(translations[currentLang].locationError); // For Multilingual Support
      const radius = document.getElementById("radius").value || 5;
      const day = document.getElementById("day").value;
      const homeDelivery = document.getElementById("homeDelivery").checked;

      fetch(`/search?lat=${originCoords.lat}&lng=${originCoords.lng}&radius=${radius}&day=${day}&homeDelivery=${homeDelivery}`)
        .then(res => res.json())
        .then(data => {
          markers.forEach(marker => marker.setMap(null));
          markers = [];

          //if (data.length === 0) return alert("No centers found.");
          if (data.length === 0) return alert(translations[currentLang].noCenters); // For Multilingual Support

          map.setCenter(originCoords);

          data.forEach(site => {
            // Use bright orange marker for agencies with updates
            const markerColor = site.has_updates ? '#FF4500' : '#5DBA68';
            const markerIcon = site.has_updates ? 
              'http://maps.google.com/mapfiles/ms/icons/orange-dot.png' : 
              'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            
            const marker = new google.maps.Marker({
              position: { lat: site.latitude, lng: site.longitude },
              map: map,
              title: site.name,
              phone: site.phone,
              icon: markerIcon
            });

            const updatesInfo = site.has_updates ? 
              `<br><strong style="color: #FF4500; font-size: 14px; background: #FFF3E0; padding: 5px; border-radius: 5px; display: inline-block;">üì¢ ${site.updates}</strong><br>` : '';
            
            const info = new google.maps.InfoWindow({
              content: `<strong>${site.name}</strong><br><br>
              <strong>Address:</strong> ${site.address}<br>
              <strong>Distance:</strong> ${site.distance} mi away <br>
              <strong>Phone:</strong> ${site.phone}<br>
              <strong>Hours of Operation:</strong> ${site.hours}<br>
              <strong>Appointment:</strong> ${site.appointment}<br>
              <strong>Prepared Meals:</strong> ${site.Prepared_meals}<br>
              <strong>Home Delivery:</strong> ${site.home_delivery}<br>
              ${updatesInfo}
              <button onclick="navigateTo(${site.latitude}, ${site.longitude})">Get Directions</button>`
            });

            marker.addListener("click", () => info.open(map, marker));
            markers.push(marker);
          });
        });
    }

    function navigateTo(lat, lng) {
      const base = "https://www.google.com/maps/dir/?api=1";
      navigator.geolocation.getCurrentPosition(pos => {
        const origin = `${pos.coords.latitude},${pos.coords.longitude}`;
        const destination = `${lat},${lng}`;
        window.open(`${base}&origin=${origin}&destination=${destination}&travelmode=driving`);
      });
    }

    // Auto-select today's day in the dropdown
    window.onload = () => {
      const days = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
      const today = new Date();
      const todayDay = days[today.getDay()];
      const dayDropdown = document.getElementById("day");
      if (dayDropdown) {
        dayDropdown.value = todayDay;
      }
    };

    // Multilingual Support


    const translations = {
      en: {
        zipLabel: "ZIP Code",
        radiusLabel: "Search Radius (miles)",
        searchZip: "Search by ZIP",
        searchCurrent: "Search From My Location üìå",
        dayLabel: "Day of the Week",
        homeDelivery: "I prefer home delivery (if available)",
        zipError: "Enter a ZIP code.",
        zipInvalid: "Invalid ZIP code.",
        noCenters: "No centers found.",
        locationError: "Unable to get your location.",
        languageLabel: "Language"
      },
      es: {
        zipLabel: "C√≥digo Postal",
        radiusLabel: "Radio de B√∫squeda (millas)",
        searchZip: "Buscar por C√≥digo",
        searchCurrent: "Buscar desde mi ubicaci√≥n üìå",
        dayLabel: "D√≠a de la semana",
        homeDelivery: "Prefiero entrega a domicilio (si est√° disponible)",
        zipError: "Ingrese un c√≥digo postal.",
        zipInvalid: "C√≥digo postal inv√°lido.",
        noCenters: "No se encontraron centros.",
        locationError: "No se pudo obtener su ubicaci√≥n.",
        languageLabel: "Idioma"
      },
      ar: {
        zipLabel: "ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑÿ®ÿ±ŸäÿØŸä",
        radiusLabel: "ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ®ÿ≠ÿ´ (ÿ£ŸÖŸäÿßŸÑ)",
        searchZip: "ÿßÿ®ÿ≠ÿ´ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑÿ®ÿ±ŸäÿØŸä",
        searchCurrent: "ÿßÿ®ÿ≠ÿ´ ŸÖŸÜ ŸÖŸàŸÇÿπŸä üìå",
        dayLabel: "ŸäŸàŸÖ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ",
        homeDelivery: "ÿ£ŸÅÿ∂ŸÑ ÿßŸÑÿ™ŸàÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ≤ŸÑŸä (ÿ•ŸÜ Ÿàÿ¨ÿØ)",
        zipError: "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑÿ®ÿ±ŸäÿØŸä.",
        zipInvalid: "ÿ±ŸÖÿ≤ ÿ®ÿ±ŸäÿØŸä ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠.",
        noCenters: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ±ÿßŸÉÿ≤.",
        locationError: "ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸàŸÇÿπŸÉ.",
        languageLabel: "ÿßŸÑŸÑÿ∫ÿ©"
      }
    };
  
    let currentLang = "en";
  
    function setLanguage(lang) {
      currentLang = lang;
      const t = translations[lang];
  
      // Labels
      document.querySelector('label[for="zip"]').textContent = t.zipLabel;
      document.querySelector('label[for="radius"]').textContent = t.radiusLabel;
      document.querySelector('label[for="day"]').textContent = t.dayLabel;
      document.querySelector('.toggle-label').textContent = t.homeDelivery;
      document.querySelector('label[for="languageSelector"]').textContent = t.languageLabel;
  
      // Buttons
      document.querySelector('button[onclick="search()"]').textContent = t.searchZip;
      document.querySelector('button[onclick="searchFromCurrentLocation()"]').textContent = t.searchCurrent;
  
      // RTL Support - Only apply to controls panel
      const controlsPanel = document.querySelector('.controls');
      if (controlsPanel) {
        controlsPanel.dir = lang === "ar" ? "rtl" : "ltr";
      }
    }
      

  </script>

  
</body>
</html>